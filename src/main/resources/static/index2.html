<!DOCTYPE html>
<html lang="en" data-theme="neo">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ktor Scraper Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        :root {
          /* Futuristic flat theme tokens */
          --bg: #0b0f14;
          --bg-elev-1: #0f141b;
          --bg-elev-2: #121925;
          --card: #0e151f;
          --surface: #101824;
          --border: #1b2431;
          --text: #e6edf3;
          --muted: #aab7c5;
          --accent: #00d4ff;
          --accent-2: #7a5cff;
          --good: #2bd576;
          --warn: #ffd35c;
          --info: #79b8ff;
          --bad: #ff6b6b;
          --chip-1: #1a2a3a;
          --chip-2: #1f2c45;
          --shadow: 0 0 0 1px var(--border);
          --radius-lg: 16px;
          --radius-md: 12px;
          --radius-sm: 10px;
          --grid-color: rgba(122, 92, 255, 0.08);
          --grid-color-2: rgba(0, 212, 255, 0.08);
        }

        html, body { height: 100%; }

        body {
          font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
          background: radial-gradient(circle at 20% -10%, rgba(122,92,255,.15), transparent 35%),
                      radial-gradient(circle at 120% 30%, rgba(0,212,255,.12), transparent 35%),
                      linear-gradient(180deg, var(--bg) 0%, #0a0e13 100%);
          color: var(--text);
        }

        /* Subtle grid */
        body::before {
          content: '';
          position: fixed;
          inset: 0;
          background-size: 32px 32px;
          background-image: linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                            linear-gradient(to bottom, var(--grid-color-2) 1px, transparent 1px);
          mask-image: radial-gradient(circle at 50% 0%, rgba(0,0,0,.25), transparent 60%);
          pointer-events: none;
          z-index: 0;
        }

        .container { position: relative; z-index: 1; margin-top: 1.5rem; max-width: 1200px; }

        /* Headline */
        .app-title {
          display: flex; align-items: center; gap: .75rem; margin-bottom: .75rem;
          letter-spacing: 0.2px; font-weight: 700;
        }
        .app-title i { color: var(--accent); filter: drop-shadow(0 0 8px rgba(0, 212, 255, .35)); }

        .subtle {
          color: var(--muted);
          font-size: .95rem;
        }

        /* Cards */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; }
        .card + .card { margin-top: 1.25rem; }
        .card-header { background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)), var(--surface); color: var(--text); border-bottom: 1px solid var(--border); padding: .85rem 1rem; }
        .card-header i { color: var(--accent-2); opacity: .9; }
        .card-body { padding: 1rem; }

        /* Buttons */
        .btn { border-radius: 999px; border: 1px solid var(--border); background: #0c131d; color: var(--text); }
        .btn:hover { filter: brightness(1.15); }
        .btn-primary { background: linear-gradient(90deg, var(--accent-2), var(--accent)); border: none; color: #041018; }
        .btn-secondary { background: #101a27; }
        .btn-info { background: #101a27; border-color: #263448; }
        .btn-warning { background: #201a12; border-color: #3e2f1a; color: #ffd35c; }
        .btn-danger { background: #1f1313; border-color: #3b1f21; color: var(--bad); }
        .btn-outline-primary, .btn-outline-success, .btn-outline-danger { background: transparent; border-color: var(--border); color: var(--muted); }
        .btn-outline-primary:hover { color: var(--accent); border-color: var(--accent); }
        .btn-outline-success:hover { color: var(--good); border-color: var(--good); }
        .btn-outline-danger:hover { color: var(--bad); border-color: var(--bad); }

        .action-button { margin-right: 6px; padding: .35rem .55rem; }

        /* Alerts */
        .alert { border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-elev-1); color: var(--text); }
        .alert-info { border-color: #1e2b3c; }
        .alert-success { border-color: #1e3a2b; color: #b3f7cf; }
        .alert-danger { border-color: #3b1f21; color: #ffb3b3; }

        /* Table */
        .table { color: var(--text); }
        .table thead th { border: 0; font-weight: 600; letter-spacing: .3px; color: var(--muted); background: var(--bg-elev-2); }
        .table-striped > tbody > tr:nth-of-type(odd) > * { background: rgba(255,255,255,0.02); }
        .table-hover > tbody > tr:hover > * { background: rgba(122, 92, 255, 0.08) !important; }
        .table td, .table th { border-color: var(--border); vertical-align: middle; }

        /* Status badges flattened */
        .badge { font-weight: 600; letter-spacing: .25px; border: 1px solid var(--border); }
        .status-PROCESSING { background: rgba(121,184,255,.12) !important; color: #79b8ff; }
        .status-PENDING { background: rgba(255,211,92,.12) !important; color: #ffd35c; }
        .status-COMPLETED { background: rgba(43,213,118,.12) !important; color: #2bd576; }
        .status-FAILED { background: rgba(255,107,107,.12) !important; color: #ff6b6b; }
        .status-UNKNOWN { background: rgba(170,183,197,.1) !important; color: var(--muted); }

        /* Group separation */
        .group-start td { border-top: 2px solid var(--border) !important; }

        /* Source color chips (flat) */
        .source-color-0 { background: #0f202b; }
        .source-color-1 { background: #231f10; }
        .source-color-2 { background: #132117; }
        .source-color-3 { background: #241520; }
        .source-color-4 { background: #19162a; }
        .source-color-5 { background: #251b11; }
        .source-color-6 { background: #132237; }

        /* Modal */
        .modal-content { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); }
        .modal-header { background: var(--surface); border-bottom: 1px solid var(--border); }
        .modal-footer { background: var(--surface); border-top: 1px solid var(--border); }
        .modal-body pre { max-height: 420px; overflow-y: auto; background: var(--bg-elev-1); color: var(--text); border-radius: var(--radius-md); padding: 1rem; border: 1px solid var(--border); }

        /* Accordion */
        .accordion { --bs-accordion-bg: var(--card); --bs-accordion-border-color: var(--border); --bs-accordion-border-radius: var(--radius-md); }
        .accordion-button { background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-md); }
        .accordion-button:not(.collapsed) { color: var(--accent); box-shadow: none; border-color: var(--accent); }
        .accordion-item { background: transparent; border: none; margin-bottom: .6rem; }
        .accordion-body { background: var(--bg-elev-1); border: 1px solid var(--border); border-radius: var(--radius-md); }

        /* List group */
        .list-group-item { background: transparent; color: var(--text); border-color: var(--border); }

        /* Forms */
        .form-select, .form-control { background: var(--bg-elev-1); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-md); }
        .form-select:focus, .form-control:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,255,0.15); }

        /* Tiny helpers */
        .muted { color: var(--muted); }
        .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius: 999px; background: var(--chip-1); border: 1px solid var(--border); color: var(--muted); font-size: .8rem; }

        /* Repo status badge */
        #repoStatus .badge { background: rgba(122,92,255,.12); color: var(--accent-2); border-color: var(--accent-2); }

        /* Responsive tweaks */
        @media (max-width: 576px) {
          .btn span { display: none; }
          .btn i { margin-right: 0 !important; }
          .action-button { margin-right: 2px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-end mb-3">
        <div>
            <h1 class="app-title mb-0"><i class="bi bi-robot"></i> Ktor Scraper Dashboard</h1>
            <div class="subtle">Flat, minimal, and a bit sci‑fi ✦</div>
        </div>
        <div class="chip"><i class="bi bi-clock-history"></i><span class="muted">Realtime view</span></div>
    </div>

    <!-- Controls -->
    <div class="card mb-4">
        <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-controller"></i>
            <span>Controls</span>
        </div>
        <div class="card-body d-flex flex-wrap align-items-center gap-2">
            <button id="refreshJobs" class="btn btn-secondary"><i class="bi bi-arrow-clockwise me-1"></i><span>Refresh List</span></button>
            <button id="addJobBtn" class="btn btn-info"><i class="bi bi-pencil-square me-1"></i><span>Add Custom Job</span></button>
            <button id="removeAllJobs" class="btn btn-danger"><i class="bi bi-trash me-1"></i><span>Remove All Jobs</span></button>
            <button id="toggleRepoBtn" class="btn btn-warning"><i class="bi bi-hdd-stack me-1"></i><span>Toggle Repo</span></button>
            <span id="repoStatus" class="ms-1"></span>
        </div>
    </div>

    <!-- Response Area -->
    <div class="card mb-4">
        <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-terminal"></i>
            <span>Last Action Response</span>
        </div>
        <div class="card-body">
            <div id="response" style="min-height:60px;"></div>
        </div>
    </div>

    <!-- Scraping Jobs Table -->
    <div class="card mb-4">
        <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-table"></i>
            <span>Scraping Jobs</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="jobsTable" class="table table-striped table-hover align-middle mb-0">
                    <thead>
                    <tr>
                        <th>UUID</th>
                        <th>Source</th>
                        <th>Status</th>
                        <th>Updated At</th>
                        <th class="text-end">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Job rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Latest Vacancies Summary -->
    <div class="card">
        <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-star-fill"></i>
            <span>Latest Vacancies by Source</span>
        </div>
        <div class="card-body">
            <div id="latestVacancies"></div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Scraping Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-content-data"></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="toggleViewBtn" class="btn btn-secondary">Show JSON</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Job Modal -->
<div class="modal fade" id="addJobModal" tabindex="-1" aria-labelledby="addJobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addJobModalLabel">Add New Scraping Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="predefinedTargets" class="form-label">Select a predefined target:</label>
                    <select id="predefinedTargets" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label for="addJobJson" class="form-label">Job JSON:</label>
                    <textarea id="addJobJson" class="form-control" rows="10"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="submitNewJob" class="btn btn-primary">Submit Job</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const responseElement = document.getElementById('response');
    const jobsTableBody = document.querySelector('#jobsTable tbody');
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    const addJobModal = new bootstrap.Modal(document.getElementById('addJobModal'));
    const modalContent = document.getElementById('modal-content-data');
    const toggleViewBtn = document.getElementById('toggleViewBtn');

    let currentVacancies = [];
    let isJsonView = false;

    const predefinedTargetsSelect = document.getElementById('predefinedTargets');
    const addJobJsonTextarea = document.getElementById('addJobJson');
    let predefinedTargets = [];

    function showResponse(message, type = 'info') {
      responseElement.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
    }

    function showLoading(button) {
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`;
      return () => {
        button.disabled = false;
        button.innerHTML = originalText;
      };
    }

    function renderVacancies(asJson = false) {
      if (asJson) {
        modalContent.innerHTML = `<pre>${JSON.stringify(currentVacancies, null, 2)}</pre>`;
        toggleViewBtn.textContent = 'Show Formatted';
        isJsonView = true;
      } else {
        let html = '<ul class="list-group">';
        currentVacancies.forEach(v => {
          html += `
            <li class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">${v.title || 'No Title'}</h5>
                <small class="muted">${v.company || 'No Company'}</small>
              </div>
              <p class="mb-1"><small class="muted">${v.location || 'No Location'}</small></p>
              <a href="${v.url}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">View Job</a>
            </li>`;
        });
        html += '</ul>';
        modalContent.innerHTML = html;
        toggleViewBtn.textContent = 'Show JSON';
        isJsonView = false;
      }
    }

    toggleViewBtn.addEventListener('click', () => {
      renderVacancies(!isJsonView);
    });

    function viewResult(jobId) {
      modalContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      resultModal.show();
      fetch(`/api/jobs/${jobId}`)
        .then(response => response.json())
        .then(job => {
          if (job.result && job.result.data && Array.isArray(job.result.data.vacancies)) {
            currentVacancies = job.result.data.vacancies;
            if (currentVacancies.length === 0) {
              modalContent.innerHTML = '<p class="text-center muted">No vacancies found for this job.</p>';
              toggleViewBtn.style.display = 'none';
              return;
            }
            toggleViewBtn.style.display = 'block';
            renderVacancies();
          } else if (job.error) {
            modalContent.innerHTML = `<div class="alert alert-danger">Error: ${job.error}</div>`;
            toggleViewBtn.style.display = 'none';
          } else {
            modalContent.innerHTML = '<p class="text-center muted">No result data available for this job.</p>';
            toggleViewBtn.style.display = 'none';
          }
        })
        .catch(error => {
          modalContent.innerHTML = `<div class="alert alert-danger">Error fetching job details: ${error}</div>`;
          toggleViewBtn.style.display = 'none';
        });
    }

    function removeJob(jobId) {
      if (!confirm(`Are you sure you want to remove job ${jobId}?`)) return;
      showResponse(`Removing job ${jobId}...`, 'info');
      fetch(`/api/jobs/${jobId}`, { method: 'DELETE' })
        .then(response => {
          if (response.ok) {
            showResponse(`Job ${jobId} removed successfully.`, 'success');
            fetchJobs();
          } else {
            throw new Error(`Failed to remove job. Status: ${response.status}`);
          }
        })
        .catch(error => showResponse(`Error: ${error}`, 'danger'));
    }

    function restartJob(jobId) {
      showResponse(`Restarting job ${jobId}...`, 'info');
      fetch(`/api/jobs/${jobId}`)
        .then(response => response.json())
        .then(job => fetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(job.source)
        }))
        .then(response => response.json())
        .then(newJob => {
          showResponse(`Job restarted successfully. New job ID: ${newJob.uuid}`, 'success');
          fetchJobs();
        })
        .catch(error => showResponse(`Error restarting job: ${error}`, 'danger'));
    }

    function fetchJobs() {
      const done = showLoading(document.getElementById('refreshJobs'));
      jobsTableBody.innerHTML = '<tr><td colspan="5" class="text-center muted">Loading...</td></tr>';
      fetch('/api/jobs')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(jobs => {
          const statusOrder = { 'PROCESSING': 1, 'PENDING': 2 };
          jobs.sort((a, b) => {
            if (a.source.name < b.source.name) return -1;
            if (a.source.name > b.source.name) return 1;
            const orderA = statusOrder[a.status] || 3;
            const orderB = statusOrder[b.status] || 3;
            return orderA - orderB;
          });

          jobsTableBody.innerHTML = '';
          if (jobs.length === 0) {
            jobsTableBody.innerHTML = '<tr><td colspan="5" class="text-center muted">No jobs found.</td></tr>';
            renderLatestVacancies([]);
            return;
          }

          let lastSource = null;
          const sourceColorMap = new Map();
          let colorIndex = 0;

          jobs.forEach(job => {
            const row = document.createElement('tr');
            const status = job.status || 'UNKNOWN';

            if (job.source.name !== lastSource) {
              row.classList.add('group-start');
              lastSource = job.source.name;
            }

            if (!sourceColorMap.has(job.source.name)) {
              sourceColorMap.set(job.source.name, colorIndex++);
            }
            const currentColorIndex = sourceColorMap.get(job.source.name) % 7;
            row.classList.add(`source-color-${currentColorIndex}`);

            const updatedAt = new Date(job.updatedAt * 1000).toLocaleString();
            row.innerHTML = `
              <td><small class="muted">${job.uuid}</small></td>
              <td>${job.source.name}</td>
              <td><span class="badge status-${status}">${status}</span></td>
              <td class="muted">${updatedAt}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary action-button" onclick="viewResult('${job.uuid}')" title="View result"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-success action-button" onclick="restartJob('${job.uuid}')" title="Restart job"><i class="bi bi-arrow-repeat"></i></button>
                <button class="btn btn-sm btn-outline-danger action-button" onclick="removeJob('${job.uuid}')" title="Remove job"><i class="bi bi-trash"></i></button>
              </td>
            `;
            jobsTableBody.appendChild(row);
          });

          renderLatestVacancies(jobs);
        })
        .catch(error => {
          jobsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading jobs: ${error}</td></tr>`;
        })
        .finally(done);
    }

    function renderLatestVacancies(jobs) {
      const latestVacanciesElement = document.getElementById('latestVacancies');
      latestVacanciesElement.innerHTML = '';

      const latestJobBySource = new Map();

      jobs
        .filter(job => job.status === 'COMPLETED' && job.result && job.result.data && Array.isArray(job.result.data.vacancies))
        .forEach(job => {
          const existing = latestJobBySource.get(job.source.name);
          if (!existing || job.updatedAt > existing.updatedAt) {
            latestJobBySource.set(job.source.name, job);
          }
        });

      if (latestJobBySource.size === 0) {
        latestVacanciesElement.innerHTML = '<p class="text-center muted">No successful job results to display yet.</p>';
        return;
      }

      const accordion = document.createElement('div');
      accordion.className = 'accordion';
      let index = 0;

      for (const [sourceName, job] of latestJobBySource.entries()) {
        const vacancies = job.result.data.vacancies;
        const accordionId = `accordion-${index}`;

        const item = document.createElement('div');
        item.className = 'accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header" id="heading-${accordionId}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}" aria-expanded="false" aria-controls="collapse-${accordionId}">
              <strong>${sourceName}</strong>&nbsp;<span class="muted">(${vacancies.length} vacancies · ${new Date(job.updatedAt * 1000).toLocaleString()})</span>
            </button>
          </h2>
          <div id="collapse-${accordionId}" class="accordion-collapse collapse" aria-labelledby="heading-${accordionId}">
            <div class="accordion-body">
              <ul class="list-group">
                ${vacancies.map(v => `
                  <li class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1">${v.title || 'No Title'}</h6>
                      <small class="muted">${v.company || 'No Company'}</small>
                    </div>
                    <p class="mb-1"><small class="muted">${v.location || 'No Location'}</small></p>
                    <a href="${v.url}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">View Job</a>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
        `;
        accordion.appendChild(item);
        index++;
      }
      latestVacanciesElement.appendChild(accordion);
    }

    document.getElementById('removeAllJobs').addEventListener('click', (e) => {
      if (!confirm('Are you sure you want to remove ALL jobs? This action cannot be undone.')) return;
      const done = showLoading(e.target);
      showResponse('Removing all jobs...', 'info');
      fetch('/api/jobs/all', { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
          showResponse(`${data.deleted_count} jobs removed successfully.`, 'success');
          fetchJobs();
        })
        .catch(error => showResponse(`Error removing all jobs: ${error}`, 'danger'))
        .finally(done);
    });

    document.getElementById('addJobBtn').addEventListener('click', () => {
      addJobModal.show();
      if (predefinedTargets.length === 0) {
        fetch('/api/default-targets')
          .then(response => response.json())
          .then(targets => {
            predefinedTargets = targets;
            predefinedTargetsSelect.innerHTML = '<option value="">-- Select a target to pre-fill --</option>';
            targets.forEach((target, index) => {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = target.name;
              predefinedTargetsSelect.appendChild(option);
            });
          });
      }
    });

    predefinedTargetsSelect.addEventListener('change', () => {
      const selectedIndex = predefinedTargetsSelect.value;
      addJobJsonTextarea.value = selectedIndex ? JSON.stringify(predefinedTargets[selectedIndex], null, 2) : '';
    });

    document.getElementById('submitNewJob').addEventListener('click', (e) => {
      const jobJson = addJobJsonTextarea.value;
      if (!jobJson) {
        alert('Job JSON cannot be empty.');
        return;
      }
      try {
        const jobData = JSON.parse(jobJson);
        const done = showLoading(e.target);
        showResponse('Submitting new job...', 'info');
        fetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(jobData)
        })
          .then(response => response.json())
          .then(newJob => {
            showResponse(`New job created successfully. ID: ${newJob.uuid}`, 'success');
            addJobModal.hide();
            fetchJobs();
          })
          .catch(error => showResponse(`Error creating job: ${error}`, 'danger'))
          .finally(done);
      } catch (err) {
        alert('Invalid JSON in the text area.');
      }
    });

    document.getElementById('refreshJobs').addEventListener('click', fetchJobs);

    // Repo toggle
    const toggleRepoBtn = document.getElementById('toggleRepoBtn');
    const repoStatusElement = document.getElementById('repoStatus');

    function updateRepoStatus(isInMemory) {
      if (isInMemory) {
        repoStatusElement.innerHTML = '<span class="badge">In‑Memory</span>';
      } else {
        repoStatusElement.innerHTML = '<span class="badge">Firestore</span>';
      }
    }

    toggleRepoBtn.addEventListener('click', (e) => {
      const done = showLoading(e.target);
      fetch('/toggle-in-memory-repo', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          updateRepoStatus(data.in_memory_repository);
          showResponse('Repository switched.', 'success');
        })
        .catch(error => showResponse(`Error toggling repository: ${error}`, 'danger'))
        .finally(done);
    });

    // Initial status check
    fetch('/repo-status')
      .then(response => response.json())
      .then(data => { updateRepoStatus(data.in_memory_repository); });

    // Kick off
    fetchJobs();
</script>
</body>
</html>
